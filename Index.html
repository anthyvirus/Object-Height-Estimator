<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Height Estimator — Inner Vault</title>
<style>
  :root{
    --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#9ca3af; --brand:#f4c430;
    --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--text); font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
  header{display:flex; align-items:center; justify-content:space-between; padding:16px 20px; border-bottom:1px solid #1f2937; position:sticky; top:0; background:rgba(11,18,32,.9); backdrop-filter:blur(6px)}
  header .logo{display:flex; align-items:center; gap:10px}
  header .dot{width:22px; height:22px; border-radius:6px; background:linear-gradient(135deg,#caa74b,#8d6e1f); box-shadow:0 0 0 1px #000 inset}
  header .title{letter-spacing:.12em; font-weight:700; color:#cbd5e1; font-size:.9rem}
  main{max-width:1100px; margin:24px auto; padding:0 16px; display:grid; gap:16px}
  .panel{background:var(--card); border:1px solid #1f2937; border-radius:16px; padding:16px}
  .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
  label.btn, button.btn{
    background:#111827; border:1px solid #273042; color:var(--text); padding:10px 14px; border-radius:12px; cursor:pointer;
  }
  button.primary{background:var(--brand); color:#1b1f2a; font-weight:800; border-color:#e9b120}
  button.ghost{background:transparent}
  input[type="number"], input[type="text"]{
    background:#0b1220; color:var(--text); border:1px solid #253045; border-radius:12px; padding:10px 12px; width:140px;
  }
  .muted{color:var(--muted); font-size:.9rem}
  #canvasWrap{position:relative; overflow:auto; border-radius:14px; border:1px dashed #334155; background:#0b1220}
  canvas{max-width:100%; height:auto; display:block; margin:auto}
  .tag{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-size:.85rem; border:1px solid #273042; background:#0b1220}
  .tag.ok{border-color:#204d2d; background:#0c2f1a; color:#a7f3d0}
  .tag.warn{border-color:#4a3a12; background:#2b1f08; color:#fde68a}
  .stack{display:flex; gap:10px; flex-wrap:wrap}
  .hint{font-size:.9rem; color:#a3a7b3}
  .divider{height:1px; background:#1f2937; margin:10px 0 14px}
</style>
</head>
<body>
  <header>
    <div class="logo">
      <div class="dot"></div>
      <div class="title">INNER VAULT • UTILITY</div>
    </div>
    <div class="stack"><span class="tag warn">Step 1: set reference</span><span class="tag">Step 2: measure object</span></div>
  </header>

  <main>
    <section class="panel">
      <div class="row">
        <input id="file" type="file" accept="image/*" />
        <button class="btn" id="fit">Fit to screen</button>
        <button class="btn ghost" id="reset">Reset</button>
        <span class="muted">Tap/click the image to place points.</span>
      </div>
      <div class="divider"></div>
      <div class="row">
        <strong>Reference height:</strong>
        <input id="refHeight" type="number" min="0" step="0.01" placeholder="e.g. 2.10" />
        <select id="units">
          <option value="m">meters</option>
          <option value="cm">cm</option>
          <option value="ft">ft</option>
          <option value="in">in</option>
        </select>
        <button class="btn" id="refMode">Set Reference (2 points)</button>
        <button class="btn" id="objMode">Measure Object (2 points)</button>
        <button class="btn primary" id="undo">Undo point</button>
      </div>
    </section>

    <section class="panel" id="canvasWrap">
      <canvas id="c"></canvas>
    </section>

    <section class="panel">
      <div class="stack">
        <span class="tag" id="refStatus">Ref px: —</span>
        <span class="tag" id="scaleStatus">Scale: —</span>
        <span class="tag ok" id="result">Result: —</span>
      </div>
      <p class="hint" style="margin-top:10px">
        Workflow: Upload → <b>Set Reference</b> and click two points on an object with a known height (door, A4 sheet, bottle).
        Enter its real height. Then click <b>Measure Object</b> and place two points on the target. We’ll convert pixels → real height.
      </p>
    </section>
  </main>

<script>
(() => {
  const file = document.getElementById('file');
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const fitBtn = document.getElementById('fit');
  const resetBtn = document.getElementById('reset');
  const refBtn = document.getElementById('refMode');
  const objBtn = document.getElementById('objMode');
  const undoBtn = document.getElementById('undo');
  const refInput = document.getElementById('refHeight');
  const unitsSel = document.getElementById('units');
  const refStatus = document.getElementById('refStatus');
  const scaleStatus = document.getElementById('scaleStatus');
  const result = document.getElementById('result');

  let img = new Image();
  let imgLoaded = false;
  let scale = null; // real per pixel
  let mode = 'ref'; // 'ref' | 'obj'
  let points = []; // all points in current pair
  let refPx = null;
  let objPx = null;

  const stateDraw = () => {
    if (!imgLoaded) { ctx.clearRect(0,0,canvas.width,canvas.height); return; }
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

    // Draw stored temporary points
    const drawDot = (p, color) => {
      ctx.fillStyle = color;
      ctx.strokeStyle = '#000';
      ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    };
    const drawLine = (a,b,color) => {
      ctx.strokeStyle = color; ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    };

    // If we already have ref/object pairs, visualize them lightly
    if (refPx && refPx.p1 && refPx.p2) { drawLine(refPx.p1, refPx.p2, '#f4c430'); drawDot(refPx.p1,'#f4c430'); drawDot(refPx.p2,'#f4c430'); }
    if (objPx && objPx.p1 && objPx.p2) { drawLine(objPx.p1, objPx.p2, '#22c55e'); drawDot(objPx.p1,'#22c55e'); drawDot(objPx.p2,'#22c55e'); }

    // Current temp points
    points.forEach((p,i)=>drawDot(p, mode==='ref'?'#f4c430':'#22c55e'));
    if (points.length===2) drawLine(points[0], points[1], mode==='ref'?'#f4c430':'#22c55e');
  };

  const setCanvasSizeToImage = (fit=true) => {
    if (!imgLoaded) return;
    const maxW = document.getElementById('canvasWrap').clientWidth - 2;
    const ratio = img.width / img.height;
    let w = img.width, h = img.height;
    if (fit || img.width > maxW) { w = Math.min(maxW, img.width); h = w / ratio; }
    canvas.width = w; canvas.height = h;
    stateDraw();
  };

  const dist = (a,b) => Math.hypot(a.x-b.x, a.y-b.y);

  const pxToReal = (px) => {
    if (scale == null) return null;
    let value = px * scale; // in base units (meters by default)
    const unit = unitsSel.value;
    if (unit === 'cm') value *= 100;
    if (unit === 'ft') value *= 3.28084;
    if (unit === 'in') value *= 39.3701;
    return value;
  };

  const updatePanels = () => {
    const fmt = (n) => (n==null || isNaN(n)) ? '—' : (Math.round(n*100)/100);
    refStatus.textContent = `Ref px: ${refPx? fmt(dist(refPx.p1,refPx.p2)) : '—'}`;
    scaleStatus.textContent = `Scale: ${scale? `${fmt(scale)} ${unitsSel.value}/px` : '—'}`;
    let res = objPx ? pxToReal(dist(objPx.p1,objPx.p2)) : null;
    result.textContent = `Result: ${res? `${fmt(res)} ${unitsSel.value}` : '—'}`;
  };

  // Handlers
  file.addEventListener('change', e=>{
    const f = e.target.files?.[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    img.onload = () => { imgLoaded = true; setCanvasSizeToImage(true); URL.revokeObjectURL(url); };
    img.src = url;
  });

  fitBtn.addEventListener('click', ()=> setCanvasSizeToImage(true));
  resetBtn.addEventListener('click', ()=>{
    points = []; refPx=null; objPx=null; scale=null; stateDraw(); updatePanels();
  });

  refBtn.addEventListener('click', ()=> { mode='ref'; points=[]; });
  objBtn.addEventListener('click', ()=> { mode='obj'; points=[]; });
  undoBtn.addEventListener('click', ()=> { points.pop(); stateDraw(); });

  canvas.addEventListener('click', (e)=>{
    if (!imgLoaded) return;
    const rect = canvas.getBoundingClientRect();
    const x = (e.clientX - rect.left); const y = (e.clientY - rect.top);
    points.push({x,y});
    if (points.length===2){
      if (mode==='ref'){
        refPx = {p1:points[0], p2:points[1]};
        const px = dist(refPx.p1,refPx.p2);
        const refRealInput = parseFloat(refInput.value);
        if (!refRealInput || refRealInput<=0) {
          alert('Enter the reference height first (e.g., 2.0 meters or 200 cm).');
        } else {
          // Convert reference input into base unit chosen
          let base = refRealInput;
          if (unitsSel.value === 'cm') base = refRealInput/100;
          if (unitsSel.value === 'ft') base = refRealInput/3.28084;
          if (unitsSel.value === 'in') base = refRealInput/39.3701;
          scale = base / px; // meters per pixel (base)
        }
      } else if (mode==='obj'){
        objPx = {p1:points[0], p2:points[1]};
      }
      points = [];
      stateDraw(); updatePanels();
    } else {
      stateDraw();
    }
  });

  window.addEventListener('resize', ()=> setCanvasSizeToImage(true));
})();
</script>
</body>
</html>
